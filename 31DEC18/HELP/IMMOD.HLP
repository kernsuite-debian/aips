; IMMOD
;---------------------------------------------------------------
;! adds images of model objects to an image
;# Task Analysis MODELING
;-----------------------------------------------------------------------
;;  Copyright (C) 1995-1997, 2005-2006, 2011
;;  Associated Universities, Inc. Washington DC, USA.
;;
;;  This program is free software; you can redistribute it and/or
;;  modify it under the terms of the GNU General Public License as
;;  published by the Free Software Foundation; either version 2 of
;;  the License, or (at your option) any later version.
;;
;;  This program is distributed in the hope that it will be useful,
;;  but WITHOUT ANY WARRANTY; without even the implied warranty of
;;  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;;  GNU General Public License for more details.
;;
;;  You should have received a copy of the GNU General Public
;;  License along with this program; if not, write to the Free
;;  Software Foundation, Inc., 675 Massachusetts Ave, Cambridge,
;;  MA 02139, USA.
;;
;;  Correspondence concerning AIPS should be addressed as follows:
;;         Internet email: aipsmail@nrao.edu.
;;         Postal address: AIPS Project Office
;;                         National Radio Astronomy Observatory
;;                         520 Edgemont Road
;;                         Charlottesville, VA 22903-2475 USA
;-----------------------------------------------------------------------
IMMOD     LLLLLLLLLLLLUUUUUUUUUUUU CCCCCCCCCCCCCCCCCCCCCCCCCCCCC
IMMOD     Task to alter map images.
INNAME                             Input image name (name).
INCLASS                            Input image name (class).
INSEQ             0.0     9999.0   Input image name (seq. #).
INDISK            0.0        9.0   Input image disk unit #.
OUTNAME                            Output image name (name).
OUTCLASS                           Output image name (class).
OUTSEQ           -1.0     9999.0   Output image name (seq. #).
OUTDISK           0.0        9.0   Output image disk unit #.
BLC                                Bottom left corner of input.
TRC                                Top right corner of input.
OPCODE                             Model types are:
                                   'GAUS', 'DISK', 'RECT',
                                   'SPHE', 'EXPD', 'POIN'
NGAUS             1.0        4.0   Number components to add
FMAX                               Peak of component (Jy/beam)
                                      no default
FPOS          -50.0     16434.0    (X,Y) position (pixels)
                                      no default
FWIDTH                             (BMAJ, BMIN, PA) of comp.
                                     (pixels,pixels,deg)
                                     0->Use clean beam
FLUX                               Noise level
FACTOR                             Multiplication factor.
INLIST                             List of sources up to 9999
----------------------------------------------------------------
IMMOD
Type: TASK
Use: Modification of existing map images by addition of models.
Adverbs:
  INNAME.....Input image name (name).     Standard defaults.
  INCLASS....Input image name (class).    Standard defaults.
  INSEQ......Input image name (seq. #).   0 => highest.
  INDISK.....Disk drive # of input image. 0 => any.
  OUTNAME....Output image name (name).    Standard defaults.
  OUTCLASS...Output image name (class).   Standard defaults.
  OUTSEQ.....Output image name (seq. #).  0 => highest unique.
  OUTDISK....Disk drive # of output image.  0 => highest
             number with sufficient space.
  BLC........Bottom right corner in input image of desired
             subimage.  Default is entire image.
  TRC........Top right corner in input image of desired
             subimage.  Default is entire image.
  OPCODE.....Operation code to determine the type of model.  Any
             undefined OPCODE => Point.  The available opcodes are
             'POIN' => Point, 'GAUS' => Gaussian, 'DISK' => Solid Disk,
             'RECT' => Solid Rectangle, 'SPHE' optically thin sphere,
             'EXPD' => Exponential
  NGAUSS.....The number of components in the model (1 - 4).
  FMAX.......The peak value for each component.   NO default.
  FPOS.......The position (X,Y) for components.  The values are in
             pixels in the order  (X1,Y1,X2,Y2,X3,Y3,X4,Y4).
             NO default.
  FWIDTH.....The major axis, minor axis and position of major axis
             for components.  The values are pixels with degrees for
             position angle and the order is
             (MJ1,MN1,PA1,MJ2,MN2,PA2,...etc)
             If the major or the minor are <= 0, then the Clean beam
             is used.
  FLUX.......Noise level to be added (in the units of the image)
  FACTOR.....Factor by which the original data is multiplied
             before it is added to the model.  0 => drop original
             data.
  INLIST.....Set this blank unless you want an input components list.
             Text file containing one line per source, giving
                I, DX, DY, Maj, Min, PA
             blank separated free format and trailing zeros may be
             omitted.  Used if INLIST not blank.  The resulting NGAUS
             will be #lines in INLIST neglecting comments (start with
             # in col 1) and lines with format errors.  Units are
             Jy/beam, pixels, pixels, pixels, pixels, degrees.  The
             Clean beam is substituted if May and/or Min are 0 or
             missing.   Limit 9999.  The model type specified by
             OPCODE is used.
----------------------------------------------------------------
IMMOD: Task which modifies map images by scaling the existing
       map and adding a specific model (See also UVMOD).
DOCUMENTOR: Eric R. Nelson NRAO/VLA/UNM
DATE OF DOCUMENTATION: 14 JUNE 1983
RELATED PROGRAMS: UVMOD, APCLN, UVMAP, COMB
VERSION 12june83

                  PURPOSE

     IMMOD modifes an already existing map image by the addition of one
of four model types.  The original map points may be scaled by a
multiplicative factor, including negative values and zero, before they
are added to the model.  Random noise may also be added to the map.  The
four available models to choose from are 1) point source, 2) Gaussian,
3) solid disk, 4) solid rectangle, 5) optically thin sphere, 6)
exponential disk..  The dimensions, offset and position angle are input
by the user.

                  COMMENTS

OPCODE :
          The type model to be used can be selected by OPCODE.  The
allowed models, and their corresponding OPCODEs are listed below.

   1) Point -> 'POIN'
         Only the specified point is altered.  The position is
         determined by FPOS.  The criterion for the point selection is
                 Sqr(X^2 + Y^2) = 0
         where (X,Y) is the current pixel location after correction for
         any offset.  Parameters BMAJ, BMIN and BPA have no affect on
         this model.  The value added is
                 ZEROSP(1) * CBarea / Cellx / Celly
         where CBarea is the Clean beam area and Cellx and Celly are the
         x and y cell sizes.

   2) Gaussian -> 'GAUS'
         The function
                 ZEROSP(1) * (CBarea/NBarea) * EXP (-4Ln(2) * R**2)
         is added to the map where
                 R = Sqrt(XX^2 + YY^2)                     with
                 XX = (Y*Cos(BPA) + X*Sin(BPA))/BMAJ
                 YY = (X*Cos(BPA) - Y*Sin(BPA))/BMIN
         where X and Y are the same as above, but in units of arcsec.
         NBarea is the new area defined by (1.1331 * BMAJ * BMIN)

   3) Disk -> 'DISK'
         A solid disk is added to the map.  The amplitude is
                 ZEROSP(1) * BMarea / (Pi * BMAJ * BMIN / 4)

   4) Rectangle -> 'RECT'
         A solid rectangle is added to the map.  The amplitude is
                 ZEROSP(1) * BMarea / (BMAJ * BMIN)

   5) Sphere -> 'SPHE'
         A circular function is added to the map:
                 ZEROSP(1) * BMarea / NBarea * sqrt (1-R*R)
         where
                 R = sqrt (X*X + Y*Y) / BMAJ
                 NBarea = 2.094 *BMAJ * BMAJ

   6) Exponential
         The function
                 ZEROSP(1) * (CBarea/NBarea) * EXP (-2ln(2) * R)
         is added to the map where R is defined above (in 2) and
                 NBarea = 3.2699 * BMAJ * BMAJ

BMAJ, BMIN, BPA (actually FWIDTH(1 through 3, i) for i'th component

     The dimensions of the resulting functions are determined by BMAJ,
BMIN and BPA (position angle).  For the Gaussian and exponential, the
first two numbers are the FWHM of the two axes.  For the disk and
rectangle, the first two values are the absolute dimensions of the two
available axes.  For the sphere, only BMAJ is used and it is the
diameter of the sphere.

     If either BMAJ or BMIN is zero, then all the models reduce to the
point model.

FACTOR :

     The FACTOR term allows one to add a scaled version of original data
to the model.  FACTOR is simply multiplied by the original data which is
then added to the model.  If FACTOR = 0 then only a map of the model
will remain.
